# **기능 명세서: 소셜 로그인 및 대화 기록 연동**

이 문서는 '예비맘, 안심 톡'의 소셜 로그인 및 대화 기록 연동 기능에 대한 기술적 요구사항을 정의합니다.

### ---

### **1. 기능 개요 (Feature Overview)**

-   **핵심 목표:** 비로그인(게스트) 상태의 사용자가 서비스에 가입하고, 기존 대화 기록을 자신의 계정에 안전하게 저장할 수 있도록 한다.
-   **주요 기능:**
    -   일정 수의 대화 이후, 사용자에게 로그인을 유도하는 UI를 노출한다.
    -   Supabase Auth를 통해 카카오 소셜 로그인을 제공한다.
    -   로그인 성공 시, 게스트 상태에서 나눈 대화 기록을 사용자의 계정과 동기화한다.

### **2. 사용자 플로우 (User Flow)**

1.  **진입:** 사용자는 온보딩 후 별도의 로그인 없이 메인 챗봇 화면에 진입한다 (게스트 상태).
2.  **대화:** AI와 자유롭게 대화를 나눈다.
3.  **로그인 유도:** 사용자가 3~5회 질문을 하면, 채팅 입력창 위에 로그인 유도 배너가 나타난다.
4.  **사용자 선택 (분기):**
    -   **'나중에 하기' 선택:** 배너가 사라지고 게스트 모드로 대화를 계속 진행한다.
    -   **'카카오로 시작하기' 선택:** Supabase Auth를 통해 카카오 로그인 화면으로 리디렉션된다.
5.  **로그인 완료:** 카카오 인증 성공 후 다시 앱으로 돌아오면 로그인 상태가 된다.
6.  **데이터 동기화:** 게스트 상태일 때의 대화 기록이 새로 생성된 사용자 계정의 데이터베이스에 자동으로 저장된다.

### **3. 요구사항 정의 (Requirements Definition)**

#### **3.1. 프론트엔드 (Frontend)**

-   **컴포넌트:**
    -   `LoginBanner.tsx` (`app/components/auth/` 경로에 생성)
        -   **표시 조건:** 사용자가 보낸 메시지 수를 관리하는 상태(`userMessageCount`)가 지정된 횟수(예: 3)를 초과할 경우 렌더링된다.
        -   **UI:** `Design Guide.md`에 명시된 텍스트("소중한 대화 기록을 안전하게 저장하고 싶다면?")와 '카카오로 시작하기', '나중에 하기' 버튼을 포함한다.
        -   **애니메이션:** `Fade-in & Slide-up` 효과를 적용하여 사용자 경험을 향상시킨다.
        -   **상호작용:**
            -   '카카오로 시작하기': Supabase 클라이언트의 `signInWithOAuth` 메소드를 'kakao' provider와 함께 호출한다.
            -   '나중에 하기': 배너를 닫는 상태 변경 함수를 호출한다.
-   **상태 관리:**
    -   사용자가 보낸 메시지 수를 추적하는 상태(`userMessageCount`)가 필요하다.
    -   로그인 배너의 노출 여부를 제어하는 `boolean` 상태(`showLoginBanner`)가 필요하다.
    -   게스트 상태의 대화 기록을 임시로 저장할 배열 상태(`guestMessages`)가 필요하다.

#### **3.2. 백엔드 (Backend) / 데이터베이스 (Database)**

-   **인증 (Supabase Auth):**
    -   Supabase 대시보드에서 카카오(Kakao) OAuth Provider를 활성화하고, 발급받은 Client ID와 Client Secret을 등록해야 한다.
    -   인증 콜백 및 세션 관리는 `@supabase/ssr` 라이브러리와 `app/lib/supabase.server.ts`의 클라이언트를 통해 처리된다.
-   **데이터베이스 스키마 (Drizzle ORM - `app/db/schema.ts`):**
    -   `users` 테이블: 사용자 프로필 정보.
        -   `id` (uuid, primary key): Supabase `auth.users`의 `id`를 참조.
        -   `email` (text)
        -   `displayName` (text, nullable): 사용자 이름.
        -   `createdAt` (timestamp): 생성일.
    -   `chat_histories` 테이블: 사용자의 대화 기록.
        -   `id` (uuid, primary key)
        -   `userId` (uuid): `users` 테이블의 `id`를 참조하는 외래 키.
        -   `messages` (jsonb): 대화 내용(사용자 질문, AI 답변)을 JSON 배열 형태로 저장.
        -   `createdAt` (timestamp): 생성일.
-   **API (Remix `action`):**
    -   **대화 기록 동기화 `action`:**
        -   로그인 성공 직후, 클라이언트에서 임시 저장 중인 게스트 대화 기록(`guestMessages`)을 이 `action`으로 전송한다.
        -   `action` 함수는 요청의 인증 정보를 확인하여 사용자 ID를 얻고, 받은 대화 기록을 해당 유저의 `chat_histories` 테이블에 저장한다.

### **4. 주요 논의/결정 사항 (Open Questions)**

-   **로그인 유도 시점:** PM과 협의하여 서비스 초기 확산 전략에 맞춰 로그인 유도를 시작할 질문 횟수를 최종 결정해야 한다. (기획: 3~5회, 논의 후 조정 가능)
-   **대화 기록 동기화 실패 처리:** 네트워크 오류 등으로 대화 기록 동기화에 실패했을 경우, 사용자에게 재시도를 요청하는 UI/UX 정책이 필요하다.
-   **게스트 대화 기록 저장 방식:** 현재는 컴포넌트의 `state`로 관리하는 것을 기본으로 하나, 페이지 새로고침 시에도 기록을 유지해야 한다면 `Session Storage` 사용을 고려해야 한다.

### ---