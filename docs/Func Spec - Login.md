# **기능 명세서: 소셜 로그인 및 대화 기록 연동**

이 문서는 '예비맘, 안심 톡'의 소셜 로그인 및 대화 기록 연동 기능에 대한 기술적 요구사항을 정의합니다.

### **2\. 기능 요구사항**

| 기능명 | 상세 설명 | 개발 난이도 | 우선순위 |
| :--- | :--- | :--- | :--- |
| 1\. 소셜 로그인 | \- 사용자는 기존에 사용하던 소셜 계정(카카오)을 통해 간편하게 회원가입 및 로그인을 할 수 있다.<br>- Clerk를 통해 카카오 소셜 로그인을 제공한다. | 쉬움 | **상** |
| 2\. 로그아웃 | \- 사용자는 언제든지 안전하게 로그아웃할 수 있다. | 쉬움 | **상** |
| 3\. 회원 탈퇴 | \- 사용자는 서비스에서 탈퇴할 수 있으며, 모든 개인 정보는 안전하게 삭제된다. | 보통 | **중** |
| 4\. 인증 상태 유지 | \- 사용자가 앱을 다시 방문했을 때, 별도의 로그인 절차 없이 인증 상태가 유지된다. | 보통 | **상** |

### **3\. 사용자 흐름 (User Flow)**

1.  **진입:** 사용자가 로그인/회원가입이 필요한 페이지에 접근하거나, 우측 상단의 '로그인' 버튼을 클릭한다.
2.  **로그인 옵션 선택:** '카카오로 시작하기' 버튼이 포함된 로그인 모달 또는 페이지가 나타난다.
3.  **인증:**
    -   **'카카오로 시작하기' 선택:** Clerk를 통해 카카오 로그인 화면으로 리디렉션된다.
    -   사용자는 카카오 계정으로 인증을 완료한다.
4.  **콜백 및 세션 생성:**
    -   인증 성공 후, 카카오에서 서비스로 리디렉션된다. (Callback URL)
    -   서버는 콜백 요청을 받아 사용자 정보를 확인하고, 서비스 자체의 세션을 생성한다.
5.  **완료:** 사용자는 로그인 상태가 되며, 이전에 요청했던 페이지로 이동하거나 메인 페이지로 이동한다.

### **4. 기술 스택 및 구현 노트**

-   **인증 라이브러리:** `@clerk/remix`
    -   Remix 애플리케이션에 Clerk 인증을 통합하기 위한 공식 라이브러리.
    -   `root.tsx`에서 앱 전체를 `ClerkApp`으로 감싸고, `loader`에서 `rootAuthLoader`를 사용하여 인증 상태를 관리한다.
    -   '카카오로 시작하기': Clerk 클라이언트의 `signInWithOAuth` 메소드를 'kakao' provider와 함께 호출한다.

-   **데이터베이스 스키마:** (Drizzle ORM, `db/schema.ts`)
    -   `users` 테이블:
        -   `id` (uuid, primary key): Clerk `auth.users`의 `id`를 참조.
        -   `name` (varchar)
        -   `email` (varchar, unique)
        -   `created_at` (timestamp)

-   **환경 변수:**
    -   `CLERK_PUBLISHABLE_KEY`
    -   `CLERK_SECRET_KEY`

### **5\. 비기능적 요구사항**

-   **보안:**
    -   비밀번호와 같은 민감한 정보는 직접 저장하지 않는다.
    -   모든 인증 관련 통신은 HTTPS를 통해 암호화되어야 한다.
-   **성능:**
    -   로그인 및 회원가입 과정은 3초 이내에 완료되어야 한다.

### **3. 요구사항 정의 (Requirements Definition)**

#### **3.1. 프론트엔드 (Frontend)**

-   **컴포넌트:**
    -   `LoginBanner.tsx` (`app/components/auth/` 경로에 생성)
        -   **표시 조건:** 사용자가 보낸 메시지 수를 관리하는 상태(`userMessageCount`)가 지정된 횟수(예: 3)를 초과할 경우 렌더링된다.
        -   **UI:** `Design Guide.md`에 명시된 텍스트("소중한 대화 기록을 안전하게 저장하고 싶다면?")와 '카카오로 시작하기', '나중에 하기' 버튼을 포함한다.
        -   **애니메이션:** `Fade-in & Slide-up` 효과를 적용하여 사용자 경험을 향상시킨다.
        -   **상호작용:**
            -   '카카오로 시작하기': Clerk 클라이언트의 `signInWithOAuth` 메소드를 'kakao' provider와 함께 호출한다.
            -   '나중에 하기': 배너를 닫는 상태 변경 함수를 호출한다.
-   **상태 관리:**
    -   사용자가 보낸 메시지 수를 추적하는 상태(`userMessageCount`)가 필요하다.
    -   로그인 배너의 노출 여부를 제어하는 `boolean` 상태(`showLoginBanner`)가 필요하다.
    -   게스트 상태의 대화 기록을 임시로 저장할 배열 상태(`guestMessages`)가 필요하다.

#### **3.2. 백엔드 (Backend) / 데이터베이스 (Database)**

-   **인증 (Supabase Auth):**
    -   Supabase 대시보드에서 카카오(Kakao) OAuth Provider를 활성화하고, 발급받은 Client ID와 Client Secret을 등록해야 한다.
    -   인증 콜백 및 세션 관리는 `@supabase/ssr` 라이브러리와 `app/lib/supabase.server.ts`의 클라이언트를 통해 처리된다.
-   **데이터베이스 스키마 (Drizzle ORM - `app/db/schema.ts`):**
    -   `users` 테이블: 사용자 프로필 정보.
        -   `id` (uuid, primary key): Supabase `auth.users`의 `id`를 참조.
        -   `email` (text)
        -   `displayName` (text, nullable): 사용자 이름.
        -   `createdAt` (timestamp): 생성일.
    -   `chat_histories` 테이블: 사용자의 대화 기록.
        -   `id` (uuid, primary key)
        -   `userId` (uuid): `users` 테이블의 `id`를 참조하는 외래 키.
        -   `messages` (jsonb): 대화 내용(사용자 질문, AI 답변)을 JSON 배열 형태로 저장.
        -   `createdAt` (timestamp): 생성일.
-   **API (Remix `action`):**
    -   **대화 기록 동기화 `action`:**
        -   로그인 성공 직후, 클라이언트에서 임시 저장 중인 게스트 대화 기록(`guestMessages`)을 이 `action`으로 전송한다.
        -   `action` 함수는 요청의 인증 정보를 확인하여 사용자 ID를 얻고, 받은 대화 기록을 해당 유저의 `chat_histories` 테이블에 저장한다.

### **4. 주요 논의/결정 사항 (Open Questions)**

-   **로그인 유도 시점:** PM과 협의하여 서비스 초기 확산 전략에 맞춰 로그인 유도를 시작할 질문 횟수를 최종 결정해야 한다. (기획: 3~5회, 논의 후 조정 가능)
-   **대화 기록 동기화 실패 처리:** 네트워크 오류 등으로 대화 기록 동기화에 실패했을 경우, 사용자에게 재시도를 요청하는 UI/UX 정책이 필요하다.
-   **게스트 대화 기록 저장 방식:** 현재는 컴포넌트의 `state`로 관리하는 것을 기본으로 하나, 페이지 새로고침 시에도 기록을 유지해야 한다면 `Session Storage` 사용을 고려해야 한다.

### ---